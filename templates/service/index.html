<!DOCTYPE html>
<html lang="ko">
  <head>
    {% include "header.html" %}
    <link
      rel="stylesheet"
      href="{{url_for('static', path='/css/general/styles.css')}}"
    />
    <link
      rel="stylesheet"
      href="{{url_for('static', path='/css/interface.general.css')}}"
    />
    <link
      rel="stylesheet"
      href="{{url_for('static', path='/css/root.general.css')}}"
    />
    <link
      rel="stylesheet"
      href="{{url_for('static', path='/css/list.module.css')}}"
    />
    <title>서비스</title>
  </head>
  <style>
    .container {
      padding-top: 10px;
    }
  </style>
  <body>
    <div id="container">
      {% include "jumbotron.html" %}
      <div id="main-container">
        {% include "navbar.html" %}
        <div class="container">
          <!-- 서비스 관리 상단 바 -->
          <div id="manage-service" class="container-item">
            <div class="item-select">
              <input
                class="form-check-input"
                type="checkbox"
                id="checkboxSelectAll"
                value=""
                aria-label="..."
              />
            </div>
            <div class="dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="filterSortDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                >필터</a
              >
              <ul class="dropdown-menu" aria-labelledby="filterSortDropdown">
                <li class="dropdown-menu-tit">필터</li>
                <li>
                  <a
                    class="dropdown-item filter-option active"
                    data-option="all"
                    href="#"
                    >전체</a
                  >
                </li>
                <li>
                  <a
                    class="dropdown-item filter-option"
                    data-option="official"
                    href="#"
                    >공식 서비스</a
                  >
                </li>
                <li>
                  <a
                    class="dropdown-item filter-option"
                    data-option="unofficial"
                    href="#"
                    >비공식 서비스</a
                  >
                </li>

                <div class="dropdown-divider"></div>

                <li class="dropdown-menu-tit">정렬</li>
                <li>
                  <a
                    class="dropdown-item sort-option"
                    data-option="join_date_asc"
                    href="#"
                    >가입일 오름차순</a
                  >
                </li>
                <li>
                  <a
                    class="dropdown-item sort-option active"
                    data-option="join_date_desc"
                    href="#"
                    >가입일 내림차순</a
                  >
                </li>
                <li>
                  <a
                    class="dropdown-item sort-option"
                    data-option="name_asc"
                    href="#"
                    >이름 오름차순</a
                  >
                </li>
                <li>
                  <a
                    class="dropdown-item sort-option"
                    data-option="name_desc"
                    href="#"
                    >이름 내림차순</a
                  >
                </li>
              </ul>
            </div>
            <div id="cnt-item-filtered" class="item-cnt me-auto"></div>
            <div class="item-search col-md-5">
              <i class="bi bi-search"></i>
              <input
                id="search-input"
                class="form-control no-border"
                type="text"
                placeholder="검색"
              />
            </div>
          </div>

          <!-- 서비스 리스트 -->
          <div id="services-container"></div>
        </div>
      </div>
    </div>
    {% include "footer.html" %}
    <script id="list2DOM" type="text/javascript" src="{{ url_for('static', path='/js/list.module.generate.js') }}" jinja-location="{{ url_for('static', path='/') }}"></script>
    <script type="text/javascript">
      (function () {
        fetch("/api/services")
          .then((res) => {
            if (!res.ok) {
              throw new Error("Network response was not OK");
            }
            return res.json();
          })
          .then((data) => {
            // console.log(data);
            const container = document.getElementById("services-container");

            function applyFilterSortSearch(
              data,
              filterOption,
              sortOption,
              searchTerm
            ) {
              // Filter data based on the filter option
              const filteredData = data.filter((item) => {
                if (filterOption === "all") {
                  return true;
                } else if (filterOption === "official") {
                  return item.is_official;
                } else if (filterOption === "unofficial") {
                  return !item.is_official;
                }
              });

              // Sort data based on the sort option
              const sortedData = filteredData.sort((a, b) => {
                if (sortOption === "join_date_asc") {
                  return new Date(a.join_date) - new Date(b.join_date);
                } else if (sortOption === "join_date_desc") {
                  return new Date(b.join_date) - new Date(a.join_date);
                } else if (sortOption === "name_asc") {
                  return a.name.localeCompare(b.name);
                } else if (sortOption === "name_desc") {
                  return b.name.localeCompare(a.name);
                } else {
                  return 0; // No sorting
                }
              });

              // Search data based on the search term
              const searchedData = sortedData.filter((item) => {
                const searchStr = searchTerm.toLowerCase();
                return (
                  item.name.toLowerCase().includes(searchStr) ||
                  item.description.toLowerCase().includes(searchStr)
                );
              });

              return searchedData;
            }

            // Additional code for filter, sort, and search
            const filterSortDropdown = document.getElementById("filterSortDropdown");
            const filterOptions = document.querySelectorAll(".filter-option");
            const sortOptions = document.querySelectorAll(".sort-option");
            const searchInput = document.getElementById("search-input");

            const checkboxSelectAll = document.getElementById("checkboxSelectAll");
            checkboxSelectAll.addEventListener("change", toggleSelectAll);

            filterOptions.forEach(option => option.addEventListener("click", updateFilterList));
            sortOptions.forEach(option => option.addEventListener("click", updateSortList));
            searchInput.addEventListener("input", updateList);

            // Add the toggleSelectAll function here
            function toggleSelectAll() {
              const checkboxes = document.querySelectorAll(".generated-checkbox");

              checkboxes.forEach(checkbox => {
                checkbox.checked = checkboxSelectAll.checked;
              });
            }

            function updateFilterList() {
              // Remove "active" class from all filter options
              filterOptions.forEach(option => option.classList.remove("active"));

              // Add "active" class to the clicked filter option
              this.classList.add("active");

              // Reset checkbox
              document.getElementById("checkboxSelectAll").checked = false;

              // Update the content of the filtered item count
              updateFilteredItemCount();

              updateList();
            }

            function updateFilteredItemCount() {
              const filterOption = document.querySelector(".filter-option.active").dataset.option;
              const filteredData = applyFilterSortSearch(data, filterOption, "", "");
              const filteredItemCount = filteredData.length;

              const cntItemFiltered = document.getElementById("cnt-item-filtered");

              // Remove existing child elements
              while (cntItemFiltered.firstChild) {
                cntItemFiltered.removeChild(cntItemFiltered.firstChild);
              }

              // Create new elements
              const spanElement = document.createElement("span");
              spanElement.textContent = filteredItemCount;

              // Append new elements to the div
              cntItemFiltered.appendChild(document.createTextNode(`${getFilterText(filterOption)} `));
              cntItemFiltered.appendChild(spanElement);
            }

            function getFilterText(filterOption) {
              if (filterOption === 'official') {
                return '공식';
              } else if (filterOption === 'unofficial') {
                return '비공식';
              } else if (filterOption === 'all') {
                return '전체';
              } else {
                return filterOption.charAt(0).toUpperCase() + filterOption.slice(1);
              }
            }

            function updateSortList() {
              // Remove "active" class from all sort options
              sortOptions.forEach((option) =>
                option.classList.remove("active")
              );

              // Add "active" class to the clicked sort option
              this.classList.add("active");

              updateList();
            }

            function updateList() {
              const filterOption = document.querySelector(
                ".filter-option.active"
              ).dataset.option;
              const sortOption = document.querySelector(".sort-option.active")
                .dataset.option;
              const searchTerm = searchInput.value;

              const filteredSortedSearchData = applyFilterSortSearch(
                data,
                filterOption,
                sortOption,
                searchTerm
              );

              // Clear existing items
              container.innerHTML = "";

              // Append the updated items to the container
              for (let i = 0; i < filteredSortedSearchData.length; i++) {
                const containerItem = getList2DOM(
                  filteredSortedSearchData[i], i
                );
                container.appendChild(containerItem);
              }
            }

            // Initialize List
            updateFilteredItemCount();
            updateList();
          })
          .catch((err) => {
            console.error("Fetch error:", err);
          });
      })();
    </script>
  </body>
</html>
